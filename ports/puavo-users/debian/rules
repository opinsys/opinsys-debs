#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

%:
	dh  $@

override_dh_auto_test:

override_dh_auto_build:
	# puavo-rest
	$(MAKE) -C rest

	# puavo-web
	$(MAKE)

override_dh_install:
	# puavo-rest
	$(MAKE) -C rest install prefix=/usr sysconfdir=/etc DESTDIR=$(CURDIR)/debian/puavo-rest
	$(MAKE) -C rest install-client prefix=/usr sysconfdir=/etc DESTDIR=$(CURDIR)/debian/puavo-load-balancer
	mkdir -p $(CURDIR)/debian/puavo-rest-nginx/etc/nginx/sites-available/
	install -m 644 $(CURDIR)/debian/nginx-puavo-rest $(CURDIR)/debian/puavo-rest-nginx/etc/nginx/sites-available/puavo-rest
	mkdir -p $(CURDIR)/debian/puavo-rest-nginx/etc/nginx/sites-enabled/
	ln -s ../sites-available/puavo-rest-nginx $(CURDIR)/debian/puavo-rest-nginx/etc/nginx/sites-enabled/puavo-rest-nginx

	# puavo-web
	$(MAKE) install prefix=/usr sysconfdir=/etc DESTDIR=$(CURDIR)/debian/puavo-web

PACKAGE = $(shell dpkg-parsechangelog | sed -ne 's/^Source: //p')
SRC_VERSION := $(shell dpkg-parsechangelog | sed -ne 's/^Version: \(\([0-9]\+\):\)\?\(.*\)-.*/\3/p')
TARBALL = $(PACKAGE)_$(SRC_VERSION).orig.tar.gz
.PHONY: get-orig-source
get-orig-source:
	wget https://github.com/opinsys/$(PACKAGE)/archive/$(SRC_VERSION).tar.gz -O../$(TARBALL)
	tar -z -x -f ../$(TARBALL) --strip-components=1 -C .
get-ref-source:
	wget https://github.com/opinsys/$(PACKAGE)/archive/$(REF).tar.gz -O../$(TARBALL)
	tar -z -x -f ../$(TARBALL) --strip-components=1 -C .
