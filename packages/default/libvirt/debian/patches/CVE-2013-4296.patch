Date: Tue,  3 Sep 2013 16:52:06 +0100
From: "Daniel P. Berrange" <berrange@redhat.com>
To: libvirt-security@redhat.com
Subject: [Libvirt-Security] [PATCH] Fix crash in remoteDispatchDomainMemoryStats

From: "Daniel P. Berrange" <berrange@redhat.com>

The 'stats' variable was not initialized to NULL, so if some
early validation of the RPC call fails, it is possible to jump
to the 'cleanup' label and VIR_FREE an uninitialized pointer.
This is a security flaw, since the API can be called from a
readonly connection which can trigger the validation checks.

This was introduced in release v0.9.1 onwards by

  commit 158ba8730e44b7dd07a21ab90499996c5dec080a
  Author: Daniel P. Berrange <berrange@redhat.com>
  Date:   Wed Apr 13 16:21:35 2011 +0100

    Merge all returns paths from dispatcher into single path

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
---
 daemon/remote.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: libvirt-1.1.1/daemon/remote.c
===================================================================
--- libvirt-1.1.1.orig/daemon/remote.c	2013-09-18 12:55:08.504103688 -0400
+++ libvirt-1.1.1/daemon/remote.c	2013-09-18 12:55:37.464103932 -0400
@@ -1139,7 +1139,7 @@
                                 remote_domain_memory_stats_ret *ret)
 {
     virDomainPtr dom = NULL;
-    struct _virDomainMemoryStat *stats;
+    struct _virDomainMemoryStat *stats = NULL;
     int nr_stats;
     size_t i;
     int rv = -1;
