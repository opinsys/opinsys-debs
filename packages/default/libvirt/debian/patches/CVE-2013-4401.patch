From 57687fd6bf7f6e1b3662c52f3f26c06ab19dc96c Mon Sep 17 00:00:00 2001
From: Daniel P. Berrange <berrange@redhat.com>
Date: Thu, 3 Oct 2013 16:37:57 +0100
Subject: [PATCH] Fix perms for virConnectDomainXML{To,From}Native (CVE-2013-4401)

The virConnectDomainXMLToNative API should require 'connect:write'
not 'connect:read', since it will trigger execution of the QEMU
binaries listed in the XML.

Also make virConnectDomainXMLFromNative API require a full
read-write connection and 'connect:write' permission. Although the
current impl doesn't trigger execution of QEMU, we should not
rely on that impl detail from an API permissioning POV.

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
---
 src/libvirt.c                |    4 ++++
 src/remote/remote_protocol.x |    4 ++--
 2 files changed, 6 insertions(+), 2 deletions(-)

Index: libvirt-1.1.1/src/libvirt.c
===================================================================
--- libvirt-1.1.1.orig/src/libvirt.c	2013-11-06 12:46:53.516952502 -0500
+++ libvirt-1.1.1/src/libvirt.c	2013-11-06 12:46:53.508952502 -0500
@@ -4604,6 +4604,10 @@
         virDispatchError(NULL);
         return NULL;
     }
+    if (conn->flags & VIR_CONNECT_RO) {
+        virLibDomainError(VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
 
     virCheckNonNullArgGoto(nativeFormat, error);
     virCheckNonNullArgGoto(nativeConfig, error);
Index: libvirt-1.1.1/src/remote/remote_protocol.x
===================================================================
--- libvirt-1.1.1.orig/src/remote/remote_protocol.x	2013-11-06 12:46:53.516952502 -0500
+++ libvirt-1.1.1/src/remote/remote_protocol.x	2013-11-06 12:46:53.512952502 -0500
@@ -3817,13 +3817,13 @@
 
     /**
      * @generate: both
-     * @acl: connect:read
+     * @acl: connect:write
      */
     REMOTE_PROC_CONNECT_DOMAIN_XML_FROM_NATIVE = 135,
 
     /**
      * @generate: both
-     * @acl: connect:read
+     * @acl: connect:write
      */
     REMOTE_PROC_CONNECT_DOMAIN_XML_TO_NATIVE = 136,
 
