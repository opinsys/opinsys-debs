#!/bin/sh

set -eu

WINEARCH=win32
WINEDLLOVERRIDES="mscoree,mshtml="
WINEPREFIX=~/.wineprefix-ti-nspire-cx-cas
WINESERVER=/opt/wine-devel/bin/wineserver

export WINEARCH WINEDLLOVERRIDES WINEPREFIX WINESERVER

tisoftdir=/opt/TINspireCXCASStudentSoftware

if [ ! -e "${WINEPREFIX}/.setup_done.1" ]; then
    # Create $WINEPREFIX

    winetricks win7

    country=$( echo "$LANG" | cut -d . -f 1 | cut -d _ -f 2)
    language=$(echo "$LANG" | cut -d . -f 1 | cut -d _ -f 1)

    tiuserwinedir="${WINEPREFIX}/drive_c/users/${USER}/Application Data/Texas Instruments/TI-Nspire CX CAS Student Software"
    mkdir -p "$tiuserwinedir"
    cp "${tisoftdir}/resources/preferences.properties" \
       "${tiuserwinedir}/preferences.properties"
    # Set the locale and country
    cat <<-EOF >> "${tiuserwinedir}/preferences.properties"
	locale=${language}
	country=${country}
	EOF

    tiwineroot="${WINEPREFIX}/drive_c/users/Public/Application Data/TI-Nspire CX CAS"
    mkdir -p "${tiwineroot}/res"
    cp "${tisoftdir}/resources/settings.properties" \
       "${tiwineroot}/res/settings.properties"
    cp "${tisoftdir}/resources/deployment.properties" \
       "${tiwineroot}/res/deployment.properties"
    mkdir -p "${WINEPREFIX}/drive_c/windows/Fonts/"
    cp ${tisoftdir}/.wineprefix/drive_c/Program\ Files/TI\ Education/TI-Nspire\ CX\ CAS\ Student\ Software/fonts/* "${WINEPREFIX}/drive_c/windows/Fonts/"

    mkdir -p "${WINEPREFIX}/drive_c/Program Files/TI Education"
    ln -fns "${tisoftdir}/.wineprefix/drive_c/Program Files/TI Education/TI-Nspire CX CAS Student Software" \
      "${WINEPREFIX}/drive_c/Program Files/TI Education/TI-Nspire CX CAS Student Software"

    # Wait for some time for wineserver to finish, but try to continue as soon
    # as possible.  One minute should be enough in all cases (there might be
    # another wineserver running, we do not care about that).
    i=0
    while pgrep -x wineserver >/dev/null && [ "$i" -lt 600 ]; do
      sleep 0.1
      i=$(($i + 1))
    done

    for filename in system.reg userdef.reg user.reg; do
      # "juhaerk" was the login that was used to install the pack
      awk -v user="$USER" '{ gsub("juhaerk", user); print }' \
        "${tisoftdir}/.wineprefix/${filename}" > "${WINEPREFIX}/${filename}"
    done

    touch "${WINEPREFIX}/.setup_done.1"
fi

/opt/wine-devel/bin/wine "${tisoftdir}/.wineprefix/drive_c/Program Files/TI Education/TI-Nspire CX CAS Student Software/TI-Nspire CX CAS Student Software.exe"
